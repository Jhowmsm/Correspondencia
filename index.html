<!-- Parte 1: Estructura visual y men칰 desplegable -->
<div class="left">
  <h2>Dise침o PDF</h2>
  <label>Subir archivo Excel:</label>
  <input type="file" id="excelFile" accept=".xlsx" /><br><br>

  <div id="fieldSelection"></div>
  <button onclick="uploadLogo()">Subir Logo</button>
  <button onclick="addTextField()">Agregar texto libre</button>
  <input type="file" id="logoFile" accept="image/*" style="display: none;" />

  <h4>Dise침a tu layout:</h4>
  <div class="toolbar">
    <label>Tama침o:
      <input type="number" id="fontSize" value="12" min="6" max="72">
    </label>
    <label>Fuente:
      <select id="fontFamily">
        <option value="helvetica">Helvetica</option>
        <option value="courier">Courier</option>
        <option value="times">Times</option>
      </select>
    </label>
    <button id="boldBtn">B</button>
    <button id="italicBtn"><i>I</i></button>
    <button id="underlineBtn"><u>U</u></button>
    <button onclick="removeSelected()">Eliminar campo</button>
  </div>

  <!-- Agregamos selector de cantidad por hoja -->
  <div style="margin-top: 10px;">
    <label>Registros por p치gina:
      <select id="recordsPerPage">
        <option value="1">1</option>
        <option value="2" selected>2</option>
        <option value="3">3</option>
      </select>
    </label>
  </div>

  <div id="designArea" class="drop-zone"></div>
  <button onclick="generarPDFCompleto()" style="margin-top: 20px;">游늯 Generar PDF completo</button>
</div>

<!-- Parte 2: Previsualizaci칩n PDF a la derecha -->
<div class="right">
  <button id="refreshPreview" onclick="generarPrevisualizacion()">游댃 Recargar vista previa</button>
  <h2>Previsualizaci칩n</h2>
  <iframe id="previewFrame"></iframe>
</div>

<script>
function generarPrevisualizacion() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit: "mm", format: "a4" });
  const maxPerPage = parseInt(document.getElementById("recordsPerPage").value);
  const verticalSpacing = 297 / maxPerPage; // dividir hoja A4 en partes iguales

  for (let i = 0; i < maxPerPage && i < excelData.length; i++) {
    renderPDF(pdf, excelData[i], i * verticalSpacing);
  }

  const blob = pdf.output("blob");
  const url = URL.createObjectURL(blob);
  document.getElementById("previewFrame").src = url;
}

function generarPDFCompleto() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit: "mm", format: "a4" });
  const maxPerPage = parseInt(document.getElementById("recordsPerPage").value);
  const verticalSpacing = 297 / maxPerPage;

  for (let i = 0; i < excelData.length; i++) {
    if (i % maxPerPage === 0 && i > 0) pdf.addPage();
    const offset = (i % maxPerPage) * verticalSpacing;
    renderPDF(pdf, excelData[i], offset);
  }

  pdf.save("resultado.pdf");
}
</script>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dise침ador PDF desde Excel</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>
<div class="container">
  <div class="left">
    <h2>Dise침o PDF</h2>
    <label>Subir archivo Excel:</label>
    <input type="file" id="excelFile" accept=".xlsx" /><br><br>

    <div id="fieldSelection"></div>
    <button onclick="uploadLogo()">Subir Logo</button>
    <button onclick="addTextField()">Agregar texto libre</button>
    <input type="file" id="logoFile" accept="image/*" style="display: none;" />

    <h4>Dise침a tu layout:</h4>
    <div class="toolbar">
      <label>Tama침o:
        <input type="number" id="fontSize" value="12" min="6" max="72">
      </label>
      <label>Fuente:
        <select id="fontFamily">
          <option value="helvetica">Helvetica</option>
          <option value="courier">Courier</option>
          <option value="times">Times</option>
        </select>
      </label>
      <button id="boldBtn">B</button>
      <button id="italicBtn"><i>I</i></button>
      <button id="underlineBtn"><u>U</u></button>
      <button onclick="removeSelected()">Eliminar campo</button>
    </div>

    <!-- Agregado: selector para cantidad por hoja -->
    <div style="margin-top: 10px;">
      <label>Registros por p치gina:
        <select id="recordsPerPage">
          <option value="1">1</option>
          <option value="2" selected>2</option>
          <option value="3">3</option>
        </select>
      </label>
    </div>

    <div id="designArea" class="drop-zone"></div>
    <button onclick="generarPDFCompleto()" style="margin-top: 20px;">游늯 Generar PDF completo</button>
  </div>

  <div class="right">
    <button id="refreshPreview" onclick="generarPrevisualizacion()">游댃 Recargar vista previa</button>
    <h2 style="padding-top: 40px;">Previsualizaci칩n</h2>
    <iframe id="previewFrame"></iframe>
  </div>
</div>

<canvas id="barcodeCanvas" width="300" height="100" style="display:none;"></canvas>
<script>
let excelData = [];
let selectedElement = null;
const PX_TO_MM = 0.2646;
const defaultMargins = { top: 20, right: 20, bottom: 20, left: 20 };

// Las funciones JavaScript restantes (procesamiento Excel, dise침o, drag-drop, PDF...) permanecen igual

function generarPrevisualizacion() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit: "mm", format: "a4" });
  const maxPerPage = parseInt(document.getElementById("recordsPerPage").value);
  const verticalSpacing = 297 / maxPerPage;
  for (let i = 0; i < maxPerPage && i < excelData.length; i++) {
    renderPDF(pdf, excelData[i], i * verticalSpacing);
  }
  const blob = pdf.output("blob");
  const url = URL.createObjectURL(blob);
  document.getElementById("previewFrame").src = url;
}

function generarPDFCompleto() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit: "mm", format: "a4" });
  const maxPerPage = parseInt(document.getElementById("recordsPerPage").value);
  const verticalSpacing = 297 / maxPerPage;
  for (let i = 0; i < excelData.length; i++) {
    if (i % maxPerPage === 0 && i > 0) pdf.addPage();
    const offset = (i % maxPerPage) * verticalSpacing;
    renderPDF(pdf, excelData[i], offset);
  }
  pdf.save("resultado.pdf");
}
</script>
</body>
</html>