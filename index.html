<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Diseñador PDF desde Excel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .drop-zone { border: 1px dashed #aaa; padding: 20px; width: 500px; height: 700px; position: relative; background: #f9f9f9; }
    .draggable { position: absolute; cursor: move; background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; }
    .controls { margin-top: 20px; }
    canvas { display: none; }
  </style>
</head>
<body>
  <h2>Diseñador de PDF desde Excel</h2>

  <label>Subir archivo Excel:</label>
  <input type="file" id="excelFile" accept=".xlsx" /><br>

  <div id="fieldSelection" class="controls"></div>
  <button onclick="uploadLogo()">Subir Logo</button>
  <input type="file" id="logoFile" accept="image/*" style="display: none;" />

  <h3>Área de diseño PDF (arrastra los campos):</h3>
  <div id="designArea" class="drop-zone"></div>

  <button onclick="generarPDF()" style="margin-top: 20px;">Generar PDF</button>

  <canvas id="barcodeCanvas"></canvas>

  <script>
    let excelData = [];
    let logoData = null;

    document.getElementById("excelFile").addEventListener("change", function(evt) {
      const file = evt.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        excelData = XLSX.utils.sheet_to_json(sheet);
        const headers = Object.keys(excelData[0]);
        renderFieldButtons(headers);
      };
      reader.readAsArrayBuffer(file);
    });

    function renderFieldButtons(headers) {
      const container = document.getElementById("fieldSelection");
      container.innerHTML = "<strong>Campos detectados:</strong><br>";
      headers.forEach(header => {
        const btn = document.createElement("button");
        btn.textContent = header;
        btn.onclick = () => addDraggableField(header);
        container.appendChild(btn);
      });
    }

    function addDraggableField(text) {
      const div = document.createElement("div");
      div.className = "draggable";
      div.textContent = `{{${text}}}`;
      div.setAttribute("data-field", text);
      div.style.left = "10px";
      div.style.top = "10px";
      document.getElementById("designArea").appendChild(div);
      makeDraggable(div);
    }

    function makeDraggable(el) {
      let offsetX, offsetY;
      el.onmousedown = function(e) {
        offsetX = e.clientX - el.offsetLeft;
        offsetY = e.clientY - el.offsetTop;
        document.onmousemove = function(e) {
          el.style.left = e.clientX - offsetX + 'px';
          el.style.top = e.clientY - offsetY + 'px';
        };
        document.onmouseup = function() {
          document.onmousemove = null;
          document.onmouseup = null;
        };
      };
    }

    function uploadLogo() {
      document.getElementById("logoFile").click();
    }

    document.getElementById("logoFile").addEventListener("change", function(evt) {
      const file = evt.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        logoData = e.target.result;
        const img = document.createElement("img");
        img.src = logoData;
        img.style.width = "80px";
        img.style.position = "absolute";
        img.style.left = "10px";
        img.style.top = "10px";
        img.className = "logo-draggable";
        document.getElementById("designArea").appendChild(img);
        makeDraggable(img);
      };
      reader.readAsDataURL(file);
    });

    async function generarPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      const designArea = document.getElementById("designArea");
      const elements = Array.from(designArea.children);

      for (let i = 0; i < excelData.length; i++) {
        if (i > 0) pdf.addPage();

        for (const el of elements) {
          const x = parseInt(el.style.left);
          const y = parseInt(el.style.top);

          if (el.tagName === "DIV") {
            const field = el.getAttribute("data-field");
            const value = excelData[i][field] || "";
            pdf.setFontSize(12);
            pdf.text(`${value}`, x, y);
          } else if (el.tagName === "IMG") {
            pdf.addImage(logoData, "PNG", x, y, 40, 20);
          }
        }

        // Código de barras
        const codigo = excelData[i]['Codigo'] || "";
        JsBarcode("#barcodeCanvas", codigo, { format: "CODE128", width: 2, height: 40, displayValue: false });
        const canvas = document.getElementById("barcodeCanvas");
        const imgData = canvas.toDataURL("image/png");
        pdf.addImage(imgData, "PNG", 10, 250, 100, 30);
      }

      pdf.save("resultado.pdf");
    }
  </script>
</body>
</html>
